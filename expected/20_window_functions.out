-- ============================================================================
-- Test 20: Advanced Window Functions
-- Tests tracking of window functions and analytical queries
-- ============================================================================
-- Reset statistics
SELECT pg_stat_insights_reset();
ERROR:  function pg_stat_insights_reset() does not exist
LINE 1: SELECT pg_stat_insights_reset();
               ^
HINT:  No function matches the given name and argument types. You might need to add explicit type casts.
-- Create test tables
SELECT setseed(0.5);
 setseed 
---------
 
(1 row)

CREATE TEMP TABLE sales_data (
  sale_id serial PRIMARY KEY,
  region text NOT NULL,
  product_id int NOT NULL,
  sale_date date NOT NULL,
  amount numeric(10,2) NOT NULL,
  quantity int NOT NULL,
  created_at timestamp DEFAULT '2025-10-31 12:00:00'::timestamp
);
CREATE TEMP TABLE employees (
  emp_id serial PRIMARY KEY,
  name text NOT NULL,
  department text NOT NULL,
  salary numeric(10,2) NOT NULL,
  hire_date date NOT NULL
);
-- Insert deterministic data
INSERT INTO sales_data (region, product_id, sale_date, amount, quantity)
SELECT 
  CASE (i % 4) WHEN 0 THEN 'north' WHEN 1 THEN 'south' WHEN 2 THEN 'east' ELSE 'west' END,
  (i % 20) + 1,
  '2024-01-01'::date + ((i % 365) || ' days')::interval,
  (i * 15.75)::numeric(10,2),
  (i % 10) + 1
FROM generate_series(1, 500) i;
INSERT INTO employees (name, department, salary, hire_date)
SELECT 
  'emp_' || i,
  CASE (i % 5) WHEN 0 THEN 'sales' WHEN 1 THEN 'marketing' WHEN 2 THEN 'engineering' WHEN 3 THEN 'hr' ELSE 'finance' END,
  (50000 + (i * 1000))::numeric(10,2),
  '2020-01-01'::date + ((i % 1000) || ' days')::interval
FROM generate_series(1, 200) i;
-- Test ROW_NUMBER()
SELECT 
  sale_id,
  region,
  amount,
  ROW_NUMBER() OVER (ORDER BY amount DESC) AS rank_by_amount
FROM sales_data
ORDER BY amount DESC
LIMIT 30;
 sale_id | region | amount  | rank_by_amount 
---------+--------+---------+----------------
     500 | north  | 7875.00 |              1
     499 | west   | 7859.25 |              2
     498 | east   | 7843.50 |              3
     497 | south  | 7827.75 |              4
     496 | north  | 7812.00 |              5
     495 | west   | 7796.25 |              6
     494 | east   | 7780.50 |              7
     493 | south  | 7764.75 |              8
     492 | north  | 7749.00 |              9
     491 | west   | 7733.25 |             10
     490 | east   | 7717.50 |             11
     489 | south  | 7701.75 |             12
     488 | north  | 7686.00 |             13
     487 | west   | 7670.25 |             14
     486 | east   | 7654.50 |             15
     485 | south  | 7638.75 |             16
     484 | north  | 7623.00 |             17
     483 | west   | 7607.25 |             18
     482 | east   | 7591.50 |             19
     481 | south  | 7575.75 |             20
     480 | north  | 7560.00 |             21
     479 | west   | 7544.25 |             22
     478 | east   | 7528.50 |             23
     477 | south  | 7512.75 |             24
     476 | north  | 7497.00 |             25
     475 | west   | 7481.25 |             26
     474 | east   | 7465.50 |             27
     473 | south  | 7449.75 |             28
     472 | north  | 7434.00 |             29
     471 | west   | 7418.25 |             30
(30 rows)

-- Test ROW_NUMBER() with PARTITION BY
SELECT 
  sale_id,
  region,
  amount,
  ROW_NUMBER() OVER (PARTITION BY region ORDER BY amount DESC) AS rank_in_region
FROM sales_data
ORDER BY region, amount DESC
LIMIT 50;
 sale_id | region | amount  | rank_in_region 
---------+--------+---------+----------------
     498 | east   | 7843.50 |              1
     494 | east   | 7780.50 |              2
     490 | east   | 7717.50 |              3
     486 | east   | 7654.50 |              4
     482 | east   | 7591.50 |              5
     478 | east   | 7528.50 |              6
     474 | east   | 7465.50 |              7
     470 | east   | 7402.50 |              8
     466 | east   | 7339.50 |              9
     462 | east   | 7276.50 |             10
     458 | east   | 7213.50 |             11
     454 | east   | 7150.50 |             12
     450 | east   | 7087.50 |             13
     446 | east   | 7024.50 |             14
     442 | east   | 6961.50 |             15
     438 | east   | 6898.50 |             16
     434 | east   | 6835.50 |             17
     430 | east   | 6772.50 |             18
     426 | east   | 6709.50 |             19
     422 | east   | 6646.50 |             20
     418 | east   | 6583.50 |             21
     414 | east   | 6520.50 |             22
     410 | east   | 6457.50 |             23
     406 | east   | 6394.50 |             24
     402 | east   | 6331.50 |             25
     398 | east   | 6268.50 |             26
     394 | east   | 6205.50 |             27
     390 | east   | 6142.50 |             28
     386 | east   | 6079.50 |             29
     382 | east   | 6016.50 |             30
     378 | east   | 5953.50 |             31
     374 | east   | 5890.50 |             32
     370 | east   | 5827.50 |             33
     366 | east   | 5764.50 |             34
     362 | east   | 5701.50 |             35
     358 | east   | 5638.50 |             36
     354 | east   | 5575.50 |             37
     350 | east   | 5512.50 |             38
     346 | east   | 5449.50 |             39
     342 | east   | 5386.50 |             40
     338 | east   | 5323.50 |             41
     334 | east   | 5260.50 |             42
     330 | east   | 5197.50 |             43
     326 | east   | 5134.50 |             44
     322 | east   | 5071.50 |             45
     318 | east   | 5008.50 |             46
     314 | east   | 4945.50 |             47
     310 | east   | 4882.50 |             48
     306 | east   | 4819.50 |             49
     302 | east   | 4756.50 |             50
(50 rows)

-- Test RANK()
SELECT 
  sale_id,
  region,
  amount,
  RANK() OVER (PARTITION BY region ORDER BY amount DESC) AS rank_amount
FROM sales_data
ORDER BY region, amount DESC
LIMIT 40;
 sale_id | region | amount  | rank_amount 
---------+--------+---------+-------------
     498 | east   | 7843.50 |           1
     494 | east   | 7780.50 |           2
     490 | east   | 7717.50 |           3
     486 | east   | 7654.50 |           4
     482 | east   | 7591.50 |           5
     478 | east   | 7528.50 |           6
     474 | east   | 7465.50 |           7
     470 | east   | 7402.50 |           8
     466 | east   | 7339.50 |           9
     462 | east   | 7276.50 |          10
     458 | east   | 7213.50 |          11
     454 | east   | 7150.50 |          12
     450 | east   | 7087.50 |          13
     446 | east   | 7024.50 |          14
     442 | east   | 6961.50 |          15
     438 | east   | 6898.50 |          16
     434 | east   | 6835.50 |          17
     430 | east   | 6772.50 |          18
     426 | east   | 6709.50 |          19
     422 | east   | 6646.50 |          20
     418 | east   | 6583.50 |          21
     414 | east   | 6520.50 |          22
     410 | east   | 6457.50 |          23
     406 | east   | 6394.50 |          24
     402 | east   | 6331.50 |          25
     398 | east   | 6268.50 |          26
     394 | east   | 6205.50 |          27
     390 | east   | 6142.50 |          28
     386 | east   | 6079.50 |          29
     382 | east   | 6016.50 |          30
     378 | east   | 5953.50 |          31
     374 | east   | 5890.50 |          32
     370 | east   | 5827.50 |          33
     366 | east   | 5764.50 |          34
     362 | east   | 5701.50 |          35
     358 | east   | 5638.50 |          36
     354 | east   | 5575.50 |          37
     350 | east   | 5512.50 |          38
     346 | east   | 5449.50 |          39
     342 | east   | 5386.50 |          40
(40 rows)

-- Test DENSE_RANK()
SELECT 
  sale_id,
  region,
  amount,
  DENSE_RANK() OVER (PARTITION BY region ORDER BY amount DESC) AS dense_rank_amount
FROM sales_data
ORDER BY region, amount DESC
LIMIT 35;
 sale_id | region | amount  | dense_rank_amount 
---------+--------+---------+-------------------
     498 | east   | 7843.50 |                 1
     494 | east   | 7780.50 |                 2
     490 | east   | 7717.50 |                 3
     486 | east   | 7654.50 |                 4
     482 | east   | 7591.50 |                 5
     478 | east   | 7528.50 |                 6
     474 | east   | 7465.50 |                 7
     470 | east   | 7402.50 |                 8
     466 | east   | 7339.50 |                 9
     462 | east   | 7276.50 |                10
     458 | east   | 7213.50 |                11
     454 | east   | 7150.50 |                12
     450 | east   | 7087.50 |                13
     446 | east   | 7024.50 |                14
     442 | east   | 6961.50 |                15
     438 | east   | 6898.50 |                16
     434 | east   | 6835.50 |                17
     430 | east   | 6772.50 |                18
     426 | east   | 6709.50 |                19
     422 | east   | 6646.50 |                20
     418 | east   | 6583.50 |                21
     414 | east   | 6520.50 |                22
     410 | east   | 6457.50 |                23
     406 | east   | 6394.50 |                24
     402 | east   | 6331.50 |                25
     398 | east   | 6268.50 |                26
     394 | east   | 6205.50 |                27
     390 | east   | 6142.50 |                28
     386 | east   | 6079.50 |                29
     382 | east   | 6016.50 |                30
     378 | east   | 5953.50 |                31
     374 | east   | 5890.50 |                32
     370 | east   | 5827.50 |                33
     366 | east   | 5764.50 |                34
     362 | east   | 5701.50 |                35
(35 rows)

-- Test PERCENT_RANK()
SELECT 
  sale_id,
  region,
  amount,
  PERCENT_RANK() OVER (PARTITION BY region ORDER BY amount) AS percent_rank
FROM sales_data
ORDER BY region, amount
LIMIT 45;
 sale_id | region | amount  |     percent_rank     
---------+--------+---------+----------------------
       2 | east   |   31.50 |                    0
       6 | east   |   94.50 | 0.008064516129032258
      10 | east   |  157.50 | 0.016129032258064516
      14 | east   |  220.50 | 0.024193548387096774
      18 | east   |  283.50 |  0.03225806451612903
      22 | east   |  346.50 |  0.04032258064516129
      26 | east   |  409.50 |  0.04838709677419355
      30 | east   |  472.50 | 0.056451612903225805
      34 | east   |  535.50 |  0.06451612903225806
      38 | east   |  598.50 |  0.07258064516129033
      42 | east   |  661.50 |  0.08064516129032258
      46 | east   |  724.50 |  0.08870967741935484
      50 | east   |  787.50 |   0.0967741935483871
      54 | east   |  850.50 |  0.10483870967741936
      58 | east   |  913.50 |  0.11290322580645161
      62 | east   |  976.50 |  0.12096774193548387
      66 | east   | 1039.50 |  0.12903225806451613
      70 | east   | 1102.50 |  0.13709677419354838
      74 | east   | 1165.50 |  0.14516129032258066
      78 | east   | 1228.50 |   0.1532258064516129
      82 | east   | 1291.50 |  0.16129032258064516
      86 | east   | 1354.50 |   0.1693548387096774
      90 | east   | 1417.50 |   0.1774193548387097
      94 | east   | 1480.50 |  0.18548387096774194
      98 | east   | 1543.50 |   0.1935483870967742
     102 | east   | 1606.50 |  0.20161290322580644
     106 | east   | 1669.50 |  0.20967741935483872
     110 | east   | 1732.50 |  0.21774193548387097
     114 | east   | 1795.50 |  0.22580645161290322
     118 | east   | 1858.50 |  0.23387096774193547
     122 | east   | 1921.50 |  0.24193548387096775
     126 | east   | 1984.50 |                 0.25
     130 | east   | 2047.50 |  0.25806451612903225
     134 | east   | 2110.50 |   0.2661290322580645
     138 | east   | 2173.50 |  0.27419354838709675
     142 | east   | 2236.50 |  0.28225806451612906
     146 | east   | 2299.50 |   0.2903225806451613
     150 | east   | 2362.50 |  0.29838709677419356
     154 | east   | 2425.50 |   0.3064516129032258
     158 | east   | 2488.50 |  0.31451612903225806
     162 | east   | 2551.50 |   0.3225806451612903
     166 | east   | 2614.50 |  0.33064516129032256
     170 | east   | 2677.50 |   0.3387096774193548
     174 | east   | 2740.50 |   0.3467741935483871
     178 | east   | 2803.50 |   0.3548387096774194
(45 rows)

-- Test CUME_DIST()
SELECT 
  sale_id,
  region,
  amount,
  CUME_DIST() OVER (PARTITION BY region ORDER BY amount) AS cumulative_dist
FROM sales_data
ORDER BY region, amount
LIMIT 40;
 sale_id | region | amount  | cumulative_dist 
---------+--------+---------+-----------------
       2 | east   |   31.50 |           0.008
       6 | east   |   94.50 |           0.016
      10 | east   |  157.50 |           0.024
      14 | east   |  220.50 |           0.032
      18 | east   |  283.50 |            0.04
      22 | east   |  346.50 |           0.048
      26 | east   |  409.50 |           0.056
      30 | east   |  472.50 |           0.064
      34 | east   |  535.50 |           0.072
      38 | east   |  598.50 |            0.08
      42 | east   |  661.50 |           0.088
      46 | east   |  724.50 |           0.096
      50 | east   |  787.50 |           0.104
      54 | east   |  850.50 |           0.112
      58 | east   |  913.50 |            0.12
      62 | east   |  976.50 |           0.128
      66 | east   | 1039.50 |           0.136
      70 | east   | 1102.50 |           0.144
      74 | east   | 1165.50 |           0.152
      78 | east   | 1228.50 |            0.16
      82 | east   | 1291.50 |           0.168
      86 | east   | 1354.50 |           0.176
      90 | east   | 1417.50 |           0.184
      94 | east   | 1480.50 |           0.192
      98 | east   | 1543.50 |             0.2
     102 | east   | 1606.50 |           0.208
     106 | east   | 1669.50 |           0.216
     110 | east   | 1732.50 |           0.224
     114 | east   | 1795.50 |           0.232
     118 | east   | 1858.50 |            0.24
     122 | east   | 1921.50 |           0.248
     126 | east   | 1984.50 |           0.256
     130 | east   | 2047.50 |           0.264
     134 | east   | 2110.50 |           0.272
     138 | east   | 2173.50 |            0.28
     142 | east   | 2236.50 |           0.288
     146 | east   | 2299.50 |           0.296
     150 | east   | 2362.50 |           0.304
     154 | east   | 2425.50 |           0.312
     158 | east   | 2488.50 |            0.32
(40 rows)

-- Test LAG()
SELECT 
  sale_id,
  region,
  sale_date,
  amount,
  LAG(amount, 1) OVER (PARTITION BY region ORDER BY sale_date) AS prev_amount,
  amount - LAG(amount, 1) OVER (PARTITION BY region ORDER BY sale_date) AS amount_diff
FROM sales_data
ORDER BY region, sale_date
LIMIT 50;
 sale_id | region | sale_date  | amount  | prev_amount | amount_diff 
---------+--------+------------+---------+-------------+-------------
     366 | east   | 01-02-2024 | 5764.50 |             |            
       2 | east   | 01-03-2024 |   31.50 |     5764.50 |    -5733.00
     370 | east   | 01-06-2024 | 5827.50 |       31.50 |     5796.00
       6 | east   | 01-07-2024 |   94.50 |     5827.50 |    -5733.00
     374 | east   | 01-10-2024 | 5890.50 |       94.50 |     5796.00
      10 | east   | 01-11-2024 |  157.50 |     5890.50 |    -5733.00
     378 | east   | 01-14-2024 | 5953.50 |      157.50 |     5796.00
      14 | east   | 01-15-2024 |  220.50 |     5953.50 |    -5733.00
     382 | east   | 01-18-2024 | 6016.50 |      220.50 |     5796.00
      18 | east   | 01-19-2024 |  283.50 |     6016.50 |    -5733.00
     386 | east   | 01-22-2024 | 6079.50 |      283.50 |     5796.00
      22 | east   | 01-23-2024 |  346.50 |     6079.50 |    -5733.00
     390 | east   | 01-26-2024 | 6142.50 |      346.50 |     5796.00
      26 | east   | 01-27-2024 |  409.50 |     6142.50 |    -5733.00
     394 | east   | 01-30-2024 | 6205.50 |      409.50 |     5796.00
      30 | east   | 01-31-2024 |  472.50 |     6205.50 |    -5733.00
     398 | east   | 02-03-2024 | 6268.50 |      472.50 |     5796.00
      34 | east   | 02-04-2024 |  535.50 |     6268.50 |    -5733.00
     402 | east   | 02-07-2024 | 6331.50 |      535.50 |     5796.00
      38 | east   | 02-08-2024 |  598.50 |     6331.50 |    -5733.00
     406 | east   | 02-11-2024 | 6394.50 |      598.50 |     5796.00
      42 | east   | 02-12-2024 |  661.50 |     6394.50 |    -5733.00
     410 | east   | 02-15-2024 | 6457.50 |      661.50 |     5796.00
      46 | east   | 02-16-2024 |  724.50 |     6457.50 |    -5733.00
     414 | east   | 02-19-2024 | 6520.50 |      724.50 |     5796.00
      50 | east   | 02-20-2024 |  787.50 |     6520.50 |    -5733.00
     418 | east   | 02-23-2024 | 6583.50 |      787.50 |     5796.00
      54 | east   | 02-24-2024 |  850.50 |     6583.50 |    -5733.00
     422 | east   | 02-27-2024 | 6646.50 |      850.50 |     5796.00
      58 | east   | 02-28-2024 |  913.50 |     6646.50 |    -5733.00
     426 | east   | 03-02-2024 | 6709.50 |      913.50 |     5796.00
      62 | east   | 03-03-2024 |  976.50 |     6709.50 |    -5733.00
     430 | east   | 03-06-2024 | 6772.50 |      976.50 |     5796.00
      66 | east   | 03-07-2024 | 1039.50 |     6772.50 |    -5733.00
     434 | east   | 03-10-2024 | 6835.50 |     1039.50 |     5796.00
      70 | east   | 03-11-2024 | 1102.50 |     6835.50 |    -5733.00
     438 | east   | 03-14-2024 | 6898.50 |     1102.50 |     5796.00
      74 | east   | 03-15-2024 | 1165.50 |     6898.50 |    -5733.00
     442 | east   | 03-18-2024 | 6961.50 |     1165.50 |     5796.00
      78 | east   | 03-19-2024 | 1228.50 |     6961.50 |    -5733.00
     446 | east   | 03-22-2024 | 7024.50 |     1228.50 |     5796.00
      82 | east   | 03-23-2024 | 1291.50 |     7024.50 |    -5733.00
     450 | east   | 03-26-2024 | 7087.50 |     1291.50 |     5796.00
      86 | east   | 03-27-2024 | 1354.50 |     7087.50 |    -5733.00
     454 | east   | 03-30-2024 | 7150.50 |     1354.50 |     5796.00
      90 | east   | 03-31-2024 | 1417.50 |     7150.50 |    -5733.00
     458 | east   | 04-03-2024 | 7213.50 |     1417.50 |     5796.00
      94 | east   | 04-04-2024 | 1480.50 |     7213.50 |    -5733.00
     462 | east   | 04-07-2024 | 7276.50 |     1480.50 |     5796.00
      98 | east   | 04-08-2024 | 1543.50 |     7276.50 |    -5733.00
(50 rows)

-- Test LEAD()
SELECT 
  sale_id,
  region,
  sale_date,
  amount,
  LEAD(amount, 1) OVER (PARTITION BY region ORDER BY sale_date) AS next_amount,
  LEAD(amount, 1) OVER (PARTITION BY region ORDER BY sale_date) - amount AS amount_diff
FROM sales_data
ORDER BY region, sale_date
LIMIT 45;
 sale_id | region | sale_date  | amount  | next_amount | amount_diff 
---------+--------+------------+---------+-------------+-------------
     366 | east   | 01-02-2024 | 5764.50 |       31.50 |    -5733.00
       2 | east   | 01-03-2024 |   31.50 |     5827.50 |     5796.00
     370 | east   | 01-06-2024 | 5827.50 |       94.50 |    -5733.00
       6 | east   | 01-07-2024 |   94.50 |     5890.50 |     5796.00
     374 | east   | 01-10-2024 | 5890.50 |      157.50 |    -5733.00
      10 | east   | 01-11-2024 |  157.50 |     5953.50 |     5796.00
     378 | east   | 01-14-2024 | 5953.50 |      220.50 |    -5733.00
      14 | east   | 01-15-2024 |  220.50 |     6016.50 |     5796.00
     382 | east   | 01-18-2024 | 6016.50 |      283.50 |    -5733.00
      18 | east   | 01-19-2024 |  283.50 |     6079.50 |     5796.00
     386 | east   | 01-22-2024 | 6079.50 |      346.50 |    -5733.00
      22 | east   | 01-23-2024 |  346.50 |     6142.50 |     5796.00
     390 | east   | 01-26-2024 | 6142.50 |      409.50 |    -5733.00
      26 | east   | 01-27-2024 |  409.50 |     6205.50 |     5796.00
     394 | east   | 01-30-2024 | 6205.50 |      472.50 |    -5733.00
      30 | east   | 01-31-2024 |  472.50 |     6268.50 |     5796.00
     398 | east   | 02-03-2024 | 6268.50 |      535.50 |    -5733.00
      34 | east   | 02-04-2024 |  535.50 |     6331.50 |     5796.00
     402 | east   | 02-07-2024 | 6331.50 |      598.50 |    -5733.00
      38 | east   | 02-08-2024 |  598.50 |     6394.50 |     5796.00
     406 | east   | 02-11-2024 | 6394.50 |      661.50 |    -5733.00
      42 | east   | 02-12-2024 |  661.50 |     6457.50 |     5796.00
     410 | east   | 02-15-2024 | 6457.50 |      724.50 |    -5733.00
      46 | east   | 02-16-2024 |  724.50 |     6520.50 |     5796.00
     414 | east   | 02-19-2024 | 6520.50 |      787.50 |    -5733.00
      50 | east   | 02-20-2024 |  787.50 |     6583.50 |     5796.00
     418 | east   | 02-23-2024 | 6583.50 |      850.50 |    -5733.00
      54 | east   | 02-24-2024 |  850.50 |     6646.50 |     5796.00
     422 | east   | 02-27-2024 | 6646.50 |      913.50 |    -5733.00
      58 | east   | 02-28-2024 |  913.50 |     6709.50 |     5796.00
     426 | east   | 03-02-2024 | 6709.50 |      976.50 |    -5733.00
      62 | east   | 03-03-2024 |  976.50 |     6772.50 |     5796.00
     430 | east   | 03-06-2024 | 6772.50 |     1039.50 |    -5733.00
      66 | east   | 03-07-2024 | 1039.50 |     6835.50 |     5796.00
     434 | east   | 03-10-2024 | 6835.50 |     1102.50 |    -5733.00
      70 | east   | 03-11-2024 | 1102.50 |     6898.50 |     5796.00
     438 | east   | 03-14-2024 | 6898.50 |     1165.50 |    -5733.00
      74 | east   | 03-15-2024 | 1165.50 |     6961.50 |     5796.00
     442 | east   | 03-18-2024 | 6961.50 |     1228.50 |    -5733.00
      78 | east   | 03-19-2024 | 1228.50 |     7024.50 |     5796.00
     446 | east   | 03-22-2024 | 7024.50 |     1291.50 |    -5733.00
      82 | east   | 03-23-2024 | 1291.50 |     7087.50 |     5796.00
     450 | east   | 03-26-2024 | 7087.50 |     1354.50 |    -5733.00
      86 | east   | 03-27-2024 | 1354.50 |     7150.50 |     5796.00
     454 | east   | 03-30-2024 | 7150.50 |     1417.50 |    -5733.00
(45 rows)

-- Test FIRST_VALUE()
SELECT 
  sale_id,
  region,
  amount,
  FIRST_VALUE(amount) OVER (PARTITION BY region ORDER BY sale_date) AS first_amount_in_region
FROM sales_data
ORDER BY region, sale_date
LIMIT 40;
 sale_id | region | amount  | first_amount_in_region 
---------+--------+---------+------------------------
     366 | east   | 5764.50 |                5764.50
       2 | east   |   31.50 |                5764.50
     370 | east   | 5827.50 |                5764.50
       6 | east   |   94.50 |                5764.50
     374 | east   | 5890.50 |                5764.50
      10 | east   |  157.50 |                5764.50
     378 | east   | 5953.50 |                5764.50
      14 | east   |  220.50 |                5764.50
     382 | east   | 6016.50 |                5764.50
      18 | east   |  283.50 |                5764.50
     386 | east   | 6079.50 |                5764.50
      22 | east   |  346.50 |                5764.50
     390 | east   | 6142.50 |                5764.50
      26 | east   |  409.50 |                5764.50
     394 | east   | 6205.50 |                5764.50
      30 | east   |  472.50 |                5764.50
     398 | east   | 6268.50 |                5764.50
      34 | east   |  535.50 |                5764.50
     402 | east   | 6331.50 |                5764.50
      38 | east   |  598.50 |                5764.50
     406 | east   | 6394.50 |                5764.50
      42 | east   |  661.50 |                5764.50
     410 | east   | 6457.50 |                5764.50
      46 | east   |  724.50 |                5764.50
     414 | east   | 6520.50 |                5764.50
      50 | east   |  787.50 |                5764.50
     418 | east   | 6583.50 |                5764.50
      54 | east   |  850.50 |                5764.50
     422 | east   | 6646.50 |                5764.50
      58 | east   |  913.50 |                5764.50
     426 | east   | 6709.50 |                5764.50
      62 | east   |  976.50 |                5764.50
     430 | east   | 6772.50 |                5764.50
      66 | east   | 1039.50 |                5764.50
     434 | east   | 6835.50 |                5764.50
      70 | east   | 1102.50 |                5764.50
     438 | east   | 6898.50 |                5764.50
      74 | east   | 1165.50 |                5764.50
     442 | east   | 6961.50 |                5764.50
      78 | east   | 1228.50 |                5764.50
(40 rows)

-- Test LAST_VALUE()
SELECT 
  sale_id,
  region,
  amount,
  LAST_VALUE(amount) OVER (PARTITION BY region ORDER BY sale_date 
    RANGE BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING) AS last_amount_in_region
FROM sales_data
ORDER BY region, sale_date
LIMIT 35;
 sale_id | region | amount  | last_amount_in_region 
---------+--------+---------+-----------------------
     366 | east   | 5764.50 |               5701.50
       2 | east   |   31.50 |               5701.50
     370 | east   | 5827.50 |               5701.50
       6 | east   |   94.50 |               5701.50
     374 | east   | 5890.50 |               5701.50
      10 | east   |  157.50 |               5701.50
     378 | east   | 5953.50 |               5701.50
      14 | east   |  220.50 |               5701.50
     382 | east   | 6016.50 |               5701.50
      18 | east   |  283.50 |               5701.50
     386 | east   | 6079.50 |               5701.50
      22 | east   |  346.50 |               5701.50
     390 | east   | 6142.50 |               5701.50
      26 | east   |  409.50 |               5701.50
     394 | east   | 6205.50 |               5701.50
      30 | east   |  472.50 |               5701.50
     398 | east   | 6268.50 |               5701.50
      34 | east   |  535.50 |               5701.50
     402 | east   | 6331.50 |               5701.50
      38 | east   |  598.50 |               5701.50
     406 | east   | 6394.50 |               5701.50
      42 | east   |  661.50 |               5701.50
     410 | east   | 6457.50 |               5701.50
      46 | east   |  724.50 |               5701.50
     414 | east   | 6520.50 |               5701.50
      50 | east   |  787.50 |               5701.50
     418 | east   | 6583.50 |               5701.50
      54 | east   |  850.50 |               5701.50
     422 | east   | 6646.50 |               5701.50
      58 | east   |  913.50 |               5701.50
     426 | east   | 6709.50 |               5701.50
      62 | east   |  976.50 |               5701.50
     430 | east   | 6772.50 |               5701.50
      66 | east   | 1039.50 |               5701.50
     434 | east   | 6835.50 |               5701.50
(35 rows)

-- Test SUM() window function
SELECT 
  sale_id,
  region,
  amount,
  SUM(amount) OVER (PARTITION BY region ORDER BY sale_date) AS running_total,
  SUM(amount) OVER (PARTITION BY region) AS region_total
FROM sales_data
ORDER BY region, sale_date
LIMIT 50;
 sale_id | region | amount  | running_total | region_total 
---------+--------+---------+---------------+--------------
     366 | east   | 5764.50 |       5764.50 |    492187.50
       2 | east   |   31.50 |       5796.00 |    492187.50
     370 | east   | 5827.50 |      11623.50 |    492187.50
       6 | east   |   94.50 |      11718.00 |    492187.50
     374 | east   | 5890.50 |      17608.50 |    492187.50
      10 | east   |  157.50 |      17766.00 |    492187.50
     378 | east   | 5953.50 |      23719.50 |    492187.50
      14 | east   |  220.50 |      23940.00 |    492187.50
     382 | east   | 6016.50 |      29956.50 |    492187.50
      18 | east   |  283.50 |      30240.00 |    492187.50
     386 | east   | 6079.50 |      36319.50 |    492187.50
      22 | east   |  346.50 |      36666.00 |    492187.50
     390 | east   | 6142.50 |      42808.50 |    492187.50
      26 | east   |  409.50 |      43218.00 |    492187.50
     394 | east   | 6205.50 |      49423.50 |    492187.50
      30 | east   |  472.50 |      49896.00 |    492187.50
     398 | east   | 6268.50 |      56164.50 |    492187.50
      34 | east   |  535.50 |      56700.00 |    492187.50
     402 | east   | 6331.50 |      63031.50 |    492187.50
      38 | east   |  598.50 |      63630.00 |    492187.50
     406 | east   | 6394.50 |      70024.50 |    492187.50
      42 | east   |  661.50 |      70686.00 |    492187.50
     410 | east   | 6457.50 |      77143.50 |    492187.50
      46 | east   |  724.50 |      77868.00 |    492187.50
     414 | east   | 6520.50 |      84388.50 |    492187.50
      50 | east   |  787.50 |      85176.00 |    492187.50
     418 | east   | 6583.50 |      91759.50 |    492187.50
      54 | east   |  850.50 |      92610.00 |    492187.50
     422 | east   | 6646.50 |      99256.50 |    492187.50
      58 | east   |  913.50 |     100170.00 |    492187.50
     426 | east   | 6709.50 |     106879.50 |    492187.50
      62 | east   |  976.50 |     107856.00 |    492187.50
     430 | east   | 6772.50 |     114628.50 |    492187.50
      66 | east   | 1039.50 |     115668.00 |    492187.50
     434 | east   | 6835.50 |     122503.50 |    492187.50
      70 | east   | 1102.50 |     123606.00 |    492187.50
     438 | east   | 6898.50 |     130504.50 |    492187.50
      74 | east   | 1165.50 |     131670.00 |    492187.50
     442 | east   | 6961.50 |     138631.50 |    492187.50
      78 | east   | 1228.50 |     139860.00 |    492187.50
     446 | east   | 7024.50 |     146884.50 |    492187.50
      82 | east   | 1291.50 |     148176.00 |    492187.50
     450 | east   | 7087.50 |     155263.50 |    492187.50
      86 | east   | 1354.50 |     156618.00 |    492187.50
     454 | east   | 7150.50 |     163768.50 |    492187.50
      90 | east   | 1417.50 |     165186.00 |    492187.50
     458 | east   | 7213.50 |     172399.50 |    492187.50
      94 | east   | 1480.50 |     173880.00 |    492187.50
     462 | east   | 7276.50 |     181156.50 |    492187.50
      98 | east   | 1543.50 |     182700.00 |    492187.50
(50 rows)

-- Test AVG() window function
SELECT 
  sale_id,
  region,
  amount,
  AVG(amount) OVER (PARTITION BY region) AS avg_region_amount,
  AVG(amount) OVER (ORDER BY sale_date ROWS BETWEEN 6 PRECEDING AND CURRENT ROW) AS moving_avg_7
FROM sales_data
ORDER BY sale_date
LIMIT 40;
 sale_id | region | amount  |   avg_region_amount   |     moving_avg_7      
---------+--------+---------+-----------------------+-----------------------
     365 | south  | 5748.75 | 3921.7500000000000000 | 5748.7500000000000000
       1 | south  |   15.75 | 3921.7500000000000000 | 2882.2500000000000000
     366 | east   | 5764.50 | 3937.5000000000000000 | 3843.0000000000000000
       2 | east   |   31.50 | 3937.5000000000000000 | 2890.1250000000000000
     367 | west   | 5780.25 | 3953.2500000000000000 | 3468.1500000000000000
       3 | west   |   47.25 | 3953.2500000000000000 | 2898.0000000000000000
     368 | north  | 5796.00 | 3969.0000000000000000 | 3312.0000000000000000
       4 | north  |   63.00 | 3969.0000000000000000 | 2499.7500000000000000
     369 | south  | 5811.75 | 3921.7500000000000000 | 3327.7500000000000000
     370 | east   | 5827.50 | 3937.5000000000000000 | 3336.7500000000000000
       5 | south  |   78.75 | 3921.7500000000000000 | 3343.5000000000000000
     371 | west   | 5843.25 | 3953.2500000000000000 | 3352.5000000000000000
       6 | east   |   94.50 | 3937.5000000000000000 | 3359.2500000000000000
       7 | west   |  110.25 | 3953.2500000000000000 | 2547.0000000000000000
     372 | north  | 5859.00 | 3969.0000000000000000 | 3375.0000000000000000
     373 | south  | 5874.75 | 3921.7500000000000000 | 3384.0000000000000000
       8 | north  |  126.00 | 3969.0000000000000000 | 2569.5000000000000000
       9 | south  |  141.75 | 3921.7500000000000000 | 2578.5000000000000000
     374 | east   | 5890.50 | 3937.5000000000000000 | 2585.2500000000000000
      10 | east   |  157.50 | 3937.5000000000000000 | 2594.2500000000000000
     375 | west   | 5906.25 | 3953.2500000000000000 | 3422.2500000000000000
      11 | west   |  173.25 | 3953.2500000000000000 | 2610.0000000000000000
     376 | north  | 5922.00 | 3969.0000000000000000 | 2616.7500000000000000
     377 | south  | 5937.75 | 3921.7500000000000000 | 3447.0000000000000000
      12 | north  |  189.00 | 3969.0000000000000000 | 3453.7500000000000000
     378 | east   | 5953.50 | 3937.5000000000000000 | 3462.7500000000000000
      13 | south  |  204.75 | 3921.7500000000000000 | 3469.5000000000000000
      14 | east   |  220.50 | 3937.5000000000000000 | 2657.2500000000000000
     379 | west   | 5969.25 | 3953.2500000000000000 | 3485.2500000000000000
      15 | west   |  236.25 | 3953.2500000000000000 | 2673.0000000000000000
     380 | north  | 5985.00 | 3969.0000000000000000 | 2679.7500000000000000
     381 | south  | 6000.75 | 3921.7500000000000000 | 3510.0000000000000000
      16 | north  |  252.00 | 3969.0000000000000000 | 2695.5000000000000000
     382 | east   | 6016.50 | 3937.5000000000000000 | 3525.7500000000000000
      17 | south  |  267.75 | 3921.7500000000000000 | 3532.5000000000000000
     383 | west   | 6032.25 | 3953.2500000000000000 | 3541.5000000000000000
      18 | east   |  283.50 | 3937.5000000000000000 | 3548.2500000000000000
     384 | north  | 6048.00 | 3969.0000000000000000 | 3557.2500000000000000
      19 | west   |  299.25 | 3953.2500000000000000 | 2742.7500000000000000
      20 | north  |  315.00 | 3969.0000000000000000 | 2751.7500000000000000
(40 rows)

-- Test COUNT() window function
SELECT 
  sale_id,
  region,
  COUNT(*) OVER (PARTITION BY region) AS region_count,
  COUNT(*) OVER (ORDER BY sale_date RANGE BETWEEN INTERVAL '7 days' PRECEDING AND CURRENT ROW) AS sales_last_7_days
FROM sales_data
ORDER BY sale_date
LIMIT 45;
 sale_id | region | region_count | sales_last_7_days 
---------+--------+--------------+-------------------
     365 | south  |          125 |                 1
       1 | south  |          125 |                 3
     366 | east   |          125 |                 3
       2 | east   |          125 |                 5
     367 | west   |          125 |                 5
       3 | west   |          125 |                 7
     368 | north  |          125 |                 7
       4 | north  |          125 |                 9
     369 | south  |          125 |                 9
     370 | east   |          125 |                11
       5 | south  |          125 |                11
     371 | west   |          125 |                13
       6 | east   |          125 |                13
       7 | west   |          125 |                15
     372 | north  |          125 |                15
     373 | south  |          125 |                16
       8 | north  |          125 |                16
       9 | south  |          125 |                16
     374 | east   |          125 |                16
      10 | east   |          125 |                16
     375 | west   |          125 |                16
      11 | west   |          125 |                16
     376 | north  |          125 |                16
     377 | south  |          125 |                16
      12 | north  |          125 |                16
     378 | east   |          125 |                16
      13 | south  |          125 |                16
      14 | east   |          125 |                16
     379 | west   |          125 |                16
      15 | west   |          125 |                16
     380 | north  |          125 |                16
     381 | south  |          125 |                16
      16 | north  |          125 |                16
     382 | east   |          125 |                16
      17 | south  |          125 |                16
     383 | west   |          125 |                16
      18 | east   |          125 |                16
     384 | north  |          125 |                16
      19 | west   |          125 |                16
      20 | north  |          125 |                16
     385 | south  |          125 |                16
     386 | east   |          125 |                16
      21 | south  |          125 |                16
      22 | east   |          125 |                16
     387 | west   |          125 |                16
(45 rows)

-- Test MIN/MAX window functions
SELECT 
  sale_id,
  region,
  amount,
  MIN(amount) OVER (PARTITION BY region) AS min_region_amount,
  MAX(amount) OVER (PARTITION BY region) AS max_region_amount
FROM sales_data
ORDER BY region, amount DESC
LIMIT 40;
 sale_id | region | amount  | min_region_amount | max_region_amount 
---------+--------+---------+-------------------+-------------------
     498 | east   | 7843.50 |             31.50 |           7843.50
     494 | east   | 7780.50 |             31.50 |           7843.50
     490 | east   | 7717.50 |             31.50 |           7843.50
     486 | east   | 7654.50 |             31.50 |           7843.50
     482 | east   | 7591.50 |             31.50 |           7843.50
     478 | east   | 7528.50 |             31.50 |           7843.50
     474 | east   | 7465.50 |             31.50 |           7843.50
     470 | east   | 7402.50 |             31.50 |           7843.50
     466 | east   | 7339.50 |             31.50 |           7843.50
     462 | east   | 7276.50 |             31.50 |           7843.50
     458 | east   | 7213.50 |             31.50 |           7843.50
     454 | east   | 7150.50 |             31.50 |           7843.50
     450 | east   | 7087.50 |             31.50 |           7843.50
     446 | east   | 7024.50 |             31.50 |           7843.50
     442 | east   | 6961.50 |             31.50 |           7843.50
     438 | east   | 6898.50 |             31.50 |           7843.50
     434 | east   | 6835.50 |             31.50 |           7843.50
     430 | east   | 6772.50 |             31.50 |           7843.50
     426 | east   | 6709.50 |             31.50 |           7843.50
     422 | east   | 6646.50 |             31.50 |           7843.50
     418 | east   | 6583.50 |             31.50 |           7843.50
     414 | east   | 6520.50 |             31.50 |           7843.50
     410 | east   | 6457.50 |             31.50 |           7843.50
     406 | east   | 6394.50 |             31.50 |           7843.50
     402 | east   | 6331.50 |             31.50 |           7843.50
     398 | east   | 6268.50 |             31.50 |           7843.50
     394 | east   | 6205.50 |             31.50 |           7843.50
     390 | east   | 6142.50 |             31.50 |           7843.50
     386 | east   | 6079.50 |             31.50 |           7843.50
     382 | east   | 6016.50 |             31.50 |           7843.50
     378 | east   | 5953.50 |             31.50 |           7843.50
     374 | east   | 5890.50 |             31.50 |           7843.50
     370 | east   | 5827.50 |             31.50 |           7843.50
     366 | east   | 5764.50 |             31.50 |           7843.50
     362 | east   | 5701.50 |             31.50 |           7843.50
     358 | east   | 5638.50 |             31.50 |           7843.50
     354 | east   | 5575.50 |             31.50 |           7843.50
     350 | east   | 5512.50 |             31.50 |           7843.50
     346 | east   | 5449.50 |             31.50 |           7843.50
     342 | east   | 5386.50 |             31.50 |           7843.50
(40 rows)

-- Test multiple window functions
SELECT 
  sale_id,
  region,
  amount,
  ROW_NUMBER() OVER (PARTITION BY region ORDER BY amount DESC) AS rank,
  SUM(amount) OVER (PARTITION BY region) AS total,
  AVG(amount) OVER (PARTITION BY region) AS average,
  PERCENT_RANK() OVER (PARTITION BY region ORDER BY amount) AS pct_rank
FROM sales_data
ORDER BY region, amount DESC
LIMIT 50;
 sale_id | region | amount  | rank |   total   |        average        |      pct_rank      
---------+--------+---------+------+-----------+-----------------------+--------------------
     498 | east   | 7843.50 |    1 | 492187.50 | 3937.5000000000000000 |                  1
     494 | east   | 7780.50 |    2 | 492187.50 | 3937.5000000000000000 | 0.9919354838709677
     490 | east   | 7717.50 |    3 | 492187.50 | 3937.5000000000000000 | 0.9838709677419355
     486 | east   | 7654.50 |    4 | 492187.50 | 3937.5000000000000000 | 0.9758064516129032
     482 | east   | 7591.50 |    5 | 492187.50 | 3937.5000000000000000 |  0.967741935483871
     478 | east   | 7528.50 |    6 | 492187.50 | 3937.5000000000000000 | 0.9596774193548387
     474 | east   | 7465.50 |    7 | 492187.50 | 3937.5000000000000000 | 0.9516129032258065
     470 | east   | 7402.50 |    8 | 492187.50 | 3937.5000000000000000 | 0.9435483870967742
     466 | east   | 7339.50 |    9 | 492187.50 | 3937.5000000000000000 | 0.9354838709677419
     462 | east   | 7276.50 |   10 | 492187.50 | 3937.5000000000000000 | 0.9274193548387096
     458 | east   | 7213.50 |   11 | 492187.50 | 3937.5000000000000000 | 0.9193548387096774
     454 | east   | 7150.50 |   12 | 492187.50 | 3937.5000000000000000 | 0.9112903225806451
     450 | east   | 7087.50 |   13 | 492187.50 | 3937.5000000000000000 | 0.9032258064516129
     446 | east   | 7024.50 |   14 | 492187.50 | 3937.5000000000000000 | 0.8951612903225806
     442 | east   | 6961.50 |   15 | 492187.50 | 3937.5000000000000000 | 0.8870967741935484
     438 | east   | 6898.50 |   16 | 492187.50 | 3937.5000000000000000 | 0.8790322580645161
     434 | east   | 6835.50 |   17 | 492187.50 | 3937.5000000000000000 | 0.8709677419354839
     430 | east   | 6772.50 |   18 | 492187.50 | 3937.5000000000000000 | 0.8629032258064516
     426 | east   | 6709.50 |   19 | 492187.50 | 3937.5000000000000000 | 0.8548387096774194
     422 | east   | 6646.50 |   20 | 492187.50 | 3937.5000000000000000 | 0.8467741935483871
     418 | east   | 6583.50 |   21 | 492187.50 | 3937.5000000000000000 | 0.8387096774193549
     414 | east   | 6520.50 |   22 | 492187.50 | 3937.5000000000000000 | 0.8306451612903226
     410 | east   | 6457.50 |   23 | 492187.50 | 3937.5000000000000000 | 0.8225806451612904
     406 | east   | 6394.50 |   24 | 492187.50 | 3937.5000000000000000 | 0.8145161290322581
     402 | east   | 6331.50 |   25 | 492187.50 | 3937.5000000000000000 | 0.8064516129032258
     398 | east   | 6268.50 |   26 | 492187.50 | 3937.5000000000000000 | 0.7983870967741935
     394 | east   | 6205.50 |   27 | 492187.50 | 3937.5000000000000000 | 0.7903225806451613
     390 | east   | 6142.50 |   28 | 492187.50 | 3937.5000000000000000 |  0.782258064516129
     386 | east   | 6079.50 |   29 | 492187.50 | 3937.5000000000000000 | 0.7741935483870968
     382 | east   | 6016.50 |   30 | 492187.50 | 3937.5000000000000000 | 0.7661290322580645
     378 | east   | 5953.50 |   31 | 492187.50 | 3937.5000000000000000 | 0.7580645161290323
     374 | east   | 5890.50 |   32 | 492187.50 | 3937.5000000000000000 |               0.75
     370 | east   | 5827.50 |   33 | 492187.50 | 3937.5000000000000000 | 0.7419354838709677
     366 | east   | 5764.50 |   34 | 492187.50 | 3937.5000000000000000 | 0.7338709677419355
     362 | east   | 5701.50 |   35 | 492187.50 | 3937.5000000000000000 | 0.7258064516129032
     358 | east   | 5638.50 |   36 | 492187.50 | 3937.5000000000000000 |  0.717741935483871
     354 | east   | 5575.50 |   37 | 492187.50 | 3937.5000000000000000 | 0.7096774193548387
     350 | east   | 5512.50 |   38 | 492187.50 | 3937.5000000000000000 | 0.7016129032258065
     346 | east   | 5449.50 |   39 | 492187.50 | 3937.5000000000000000 | 0.6935483870967742
     342 | east   | 5386.50 |   40 | 492187.50 | 3937.5000000000000000 | 0.6854838709677419
     338 | east   | 5323.50 |   41 | 492187.50 | 3937.5000000000000000 | 0.6774193548387096
     334 | east   | 5260.50 |   42 | 492187.50 | 3937.5000000000000000 | 0.6693548387096774
     330 | east   | 5197.50 |   43 | 492187.50 | 3937.5000000000000000 | 0.6612903225806451
     326 | east   | 5134.50 |   44 | 492187.50 | 3937.5000000000000000 | 0.6532258064516129
     322 | east   | 5071.50 |   45 | 492187.50 | 3937.5000000000000000 | 0.6451612903225806
     318 | east   | 5008.50 |   46 | 492187.50 | 3937.5000000000000000 | 0.6370967741935484
     314 | east   | 4945.50 |   47 | 492187.50 | 3937.5000000000000000 | 0.6290322580645161
     310 | east   | 4882.50 |   48 | 492187.50 | 3937.5000000000000000 | 0.6209677419354839
     306 | east   | 4819.50 |   49 | 492187.50 | 3937.5000000000000000 | 0.6129032258064516
     302 | east   | 4756.50 |   50 | 492187.50 | 3937.5000000000000000 | 0.6048387096774194
(50 rows)

-- Test window frames - ROWS
SELECT 
  sale_id,
  amount,
  SUM(amount) OVER (ORDER BY sale_id ROWS BETWEEN 2 PRECEDING AND CURRENT ROW) AS sum_3_rows,
  AVG(amount) OVER (ORDER BY sale_id ROWS BETWEEN 4 PRECEDING AND 1 FOLLOWING) AS avg_6_rows
FROM sales_data
ORDER BY sale_id
LIMIT 40;
 sale_id | amount | sum_3_rows |      avg_6_rows      
---------+--------+------------+----------------------
       1 |  15.75 |      15.75 |  23.6250000000000000
       2 |  31.50 |      47.25 |  31.5000000000000000
       3 |  47.25 |      94.50 |  39.3750000000000000
       4 |  63.00 |     141.75 |  47.2500000000000000
       5 |  78.75 |     189.00 |  55.1250000000000000
       6 |  94.50 |     236.25 |  70.8750000000000000
       7 | 110.25 |     283.50 |  86.6250000000000000
       8 | 126.00 |     330.75 | 102.3750000000000000
       9 | 141.75 |     378.00 | 118.1250000000000000
      10 | 157.50 |     425.25 | 133.8750000000000000
      11 | 173.25 |     472.50 | 149.6250000000000000
      12 | 189.00 |     519.75 | 165.3750000000000000
      13 | 204.75 |     567.00 | 181.1250000000000000
      14 | 220.50 |     614.25 | 196.8750000000000000
      15 | 236.25 |     661.50 | 212.6250000000000000
      16 | 252.00 |     708.75 | 228.3750000000000000
      17 | 267.75 |     756.00 | 244.1250000000000000
      18 | 283.50 |     803.25 | 259.8750000000000000
      19 | 299.25 |     850.50 | 275.6250000000000000
      20 | 315.00 |     897.75 | 291.3750000000000000
      21 | 330.75 |     945.00 | 307.1250000000000000
      22 | 346.50 |     992.25 | 322.8750000000000000
      23 | 362.25 |    1039.50 | 338.6250000000000000
      24 | 378.00 |    1086.75 | 354.3750000000000000
      25 | 393.75 |    1134.00 | 370.1250000000000000
      26 | 409.50 |    1181.25 | 385.8750000000000000
      27 | 425.25 |    1228.50 | 401.6250000000000000
      28 | 441.00 |    1275.75 | 417.3750000000000000
      29 | 456.75 |    1323.00 | 433.1250000000000000
      30 | 472.50 |    1370.25 | 448.8750000000000000
      31 | 488.25 |    1417.50 | 464.6250000000000000
      32 | 504.00 |    1464.75 | 480.3750000000000000
      33 | 519.75 |    1512.00 | 496.1250000000000000
      34 | 535.50 |    1559.25 | 511.8750000000000000
      35 | 551.25 |    1606.50 | 527.6250000000000000
      36 | 567.00 |    1653.75 | 543.3750000000000000
      37 | 582.75 |    1701.00 | 559.1250000000000000
      38 | 598.50 |    1748.25 | 574.8750000000000000
      39 | 614.25 |    1795.50 | 590.6250000000000000
      40 | 630.00 |    1842.75 | 606.3750000000000000
(40 rows)

-- Test window frames - RANGE
SELECT 
  sale_id,
  sale_date,
  amount,
  SUM(amount) OVER (ORDER BY sale_date RANGE BETWEEN INTERVAL '7 days' PRECEDING AND CURRENT ROW) AS sum_7_days
FROM sales_data
ORDER BY sale_date
LIMIT 35;
 sale_id | sale_date  | amount  | sum_7_days 
---------+------------+---------+------------
     365 | 01-01-2024 | 5748.75 |    5748.75
     366 | 01-02-2024 | 5764.50 |   11529.00
       1 | 01-02-2024 |   15.75 |   11529.00
       2 | 01-03-2024 |   31.50 |   17340.75
     367 | 01-03-2024 | 5780.25 |   17340.75
       3 | 01-04-2024 |   47.25 |   23184.00
     368 | 01-04-2024 | 5796.00 |   23184.00
     369 | 01-05-2024 | 5811.75 |   29058.75
       4 | 01-05-2024 |   63.00 |   29058.75
     370 | 01-06-2024 | 5827.50 |   34965.00
       5 | 01-06-2024 |   78.75 |   34965.00
       6 | 01-07-2024 |   94.50 |   40902.75
     371 | 01-07-2024 | 5843.25 |   40902.75
       7 | 01-08-2024 |  110.25 |   46872.00
     372 | 01-08-2024 | 5859.00 |   46872.00
     373 | 01-09-2024 | 5874.75 |   47124.00
       8 | 01-09-2024 |  126.00 |   47124.00
     374 | 01-10-2024 | 5890.50 |   47376.00
       9 | 01-10-2024 |  141.75 |   47376.00
      10 | 01-11-2024 |  157.50 |   47628.00
     375 | 01-11-2024 | 5906.25 |   47628.00
      11 | 01-12-2024 |  173.25 |   47880.00
     376 | 01-12-2024 | 5922.00 |   47880.00
      12 | 01-13-2024 |  189.00 |   48132.00
     377 | 01-13-2024 | 5937.75 |   48132.00
      13 | 01-14-2024 |  204.75 |   48384.00
     378 | 01-14-2024 | 5953.50 |   48384.00
      14 | 01-15-2024 |  220.50 |   48636.00
     379 | 01-15-2024 | 5969.25 |   48636.00
      15 | 01-16-2024 |  236.25 |   48888.00
     380 | 01-16-2024 | 5985.00 |   48888.00
      16 | 01-17-2024 |  252.00 |   49140.00
     381 | 01-17-2024 | 6000.75 |   49140.00
     382 | 01-18-2024 | 6016.50 |   49392.00
      17 | 01-18-2024 |  267.75 |   49392.00
(35 rows)

-- Test NTILE()
SELECT 
  sale_id,
  region,
  amount,
  NTILE(4) OVER (PARTITION BY region ORDER BY amount DESC) AS quartile
FROM sales_data
ORDER BY region, amount DESC
LIMIT 45;
 sale_id | region | amount  | quartile 
---------+--------+---------+----------
     498 | east   | 7843.50 |        1
     494 | east   | 7780.50 |        1
     490 | east   | 7717.50 |        1
     486 | east   | 7654.50 |        1
     482 | east   | 7591.50 |        1
     478 | east   | 7528.50 |        1
     474 | east   | 7465.50 |        1
     470 | east   | 7402.50 |        1
     466 | east   | 7339.50 |        1
     462 | east   | 7276.50 |        1
     458 | east   | 7213.50 |        1
     454 | east   | 7150.50 |        1
     450 | east   | 7087.50 |        1
     446 | east   | 7024.50 |        1
     442 | east   | 6961.50 |        1
     438 | east   | 6898.50 |        1
     434 | east   | 6835.50 |        1
     430 | east   | 6772.50 |        1
     426 | east   | 6709.50 |        1
     422 | east   | 6646.50 |        1
     418 | east   | 6583.50 |        1
     414 | east   | 6520.50 |        1
     410 | east   | 6457.50 |        1
     406 | east   | 6394.50 |        1
     402 | east   | 6331.50 |        1
     398 | east   | 6268.50 |        1
     394 | east   | 6205.50 |        1
     390 | east   | 6142.50 |        1
     386 | east   | 6079.50 |        1
     382 | east   | 6016.50 |        1
     378 | east   | 5953.50 |        1
     374 | east   | 5890.50 |        1
     370 | east   | 5827.50 |        2
     366 | east   | 5764.50 |        2
     362 | east   | 5701.50 |        2
     358 | east   | 5638.50 |        2
     354 | east   | 5575.50 |        2
     350 | east   | 5512.50 |        2
     346 | east   | 5449.50 |        2
     342 | east   | 5386.50 |        2
     338 | east   | 5323.50 |        2
     334 | east   | 5260.50 |        2
     330 | east   | 5197.50 |        2
     326 | east   | 5134.50 |        2
     322 | east   | 5071.50 |        2
(45 rows)

-- Test window function with JOIN
SELECT 
  e.emp_id,
  e.name,
  e.department,
  e.salary,
  RANK() OVER (PARTITION BY e.department ORDER BY e.salary DESC) AS dept_salary_rank,
  AVG(e.salary) OVER (PARTITION BY e.department) AS dept_avg_salary
FROM employees e
ORDER BY e.department, e.salary DESC
LIMIT 50;
 emp_id |  name   | department  |  salary   | dept_salary_rank |   dept_avg_salary   
--------+---------+-------------+-----------+------------------+---------------------
    197 | emp_197 | engineering | 247000.00 |                1 | 149500.000000000000
    192 | emp_192 | engineering | 242000.00 |                2 | 149500.000000000000
    187 | emp_187 | engineering | 237000.00 |                3 | 149500.000000000000
    182 | emp_182 | engineering | 232000.00 |                4 | 149500.000000000000
    177 | emp_177 | engineering | 227000.00 |                5 | 149500.000000000000
    172 | emp_172 | engineering | 222000.00 |                6 | 149500.000000000000
    167 | emp_167 | engineering | 217000.00 |                7 | 149500.000000000000
    162 | emp_162 | engineering | 212000.00 |                8 | 149500.000000000000
    157 | emp_157 | engineering | 207000.00 |                9 | 149500.000000000000
    152 | emp_152 | engineering | 202000.00 |               10 | 149500.000000000000
    147 | emp_147 | engineering | 197000.00 |               11 | 149500.000000000000
    142 | emp_142 | engineering | 192000.00 |               12 | 149500.000000000000
    137 | emp_137 | engineering | 187000.00 |               13 | 149500.000000000000
    132 | emp_132 | engineering | 182000.00 |               14 | 149500.000000000000
    127 | emp_127 | engineering | 177000.00 |               15 | 149500.000000000000
    122 | emp_122 | engineering | 172000.00 |               16 | 149500.000000000000
    117 | emp_117 | engineering | 167000.00 |               17 | 149500.000000000000
    112 | emp_112 | engineering | 162000.00 |               18 | 149500.000000000000
    107 | emp_107 | engineering | 157000.00 |               19 | 149500.000000000000
    102 | emp_102 | engineering | 152000.00 |               20 | 149500.000000000000
     97 | emp_97  | engineering | 147000.00 |               21 | 149500.000000000000
     92 | emp_92  | engineering | 142000.00 |               22 | 149500.000000000000
     87 | emp_87  | engineering | 137000.00 |               23 | 149500.000000000000
     82 | emp_82  | engineering | 132000.00 |               24 | 149500.000000000000
     77 | emp_77  | engineering | 127000.00 |               25 | 149500.000000000000
     72 | emp_72  | engineering | 122000.00 |               26 | 149500.000000000000
     67 | emp_67  | engineering | 117000.00 |               27 | 149500.000000000000
     62 | emp_62  | engineering | 112000.00 |               28 | 149500.000000000000
     57 | emp_57  | engineering | 107000.00 |               29 | 149500.000000000000
     52 | emp_52  | engineering | 102000.00 |               30 | 149500.000000000000
     47 | emp_47  | engineering |  97000.00 |               31 | 149500.000000000000
     42 | emp_42  | engineering |  92000.00 |               32 | 149500.000000000000
     37 | emp_37  | engineering |  87000.00 |               33 | 149500.000000000000
     32 | emp_32  | engineering |  82000.00 |               34 | 149500.000000000000
     27 | emp_27  | engineering |  77000.00 |               35 | 149500.000000000000
     22 | emp_22  | engineering |  72000.00 |               36 | 149500.000000000000
     17 | emp_17  | engineering |  67000.00 |               37 | 149500.000000000000
     12 | emp_12  | engineering |  62000.00 |               38 | 149500.000000000000
      7 | emp_7   | engineering |  57000.00 |               39 | 149500.000000000000
      2 | emp_2   | engineering |  52000.00 |               40 | 149500.000000000000
    199 | emp_199 | finance     | 249000.00 |                1 | 151500.000000000000
    194 | emp_194 | finance     | 244000.00 |                2 | 151500.000000000000
    189 | emp_189 | finance     | 239000.00 |                3 | 151500.000000000000
    184 | emp_184 | finance     | 234000.00 |                4 | 151500.000000000000
    179 | emp_179 | finance     | 229000.00 |                5 | 151500.000000000000
    174 | emp_174 | finance     | 224000.00 |                6 | 151500.000000000000
    169 | emp_169 | finance     | 219000.00 |                7 | 151500.000000000000
    164 | emp_164 | finance     | 214000.00 |                8 | 151500.000000000000
    159 | emp_159 | finance     | 209000.00 |                9 | 151500.000000000000
    154 | emp_154 | finance     | 204000.00 |               10 | 151500.000000000000
(50 rows)

-- Test nested window functions (in subquery)
SELECT 
  region,
  sale_id,
  amount,
  rank_within_region,
  amount - LAG(amount, 1) OVER (PARTITION BY region ORDER BY sale_id) AS diff_from_prev
FROM (
  SELECT 
    sale_id,
    region,
    amount,
    ROW_NUMBER() OVER (PARTITION BY region ORDER BY amount DESC) AS rank_within_region
  FROM sales_data
) ranked
ORDER BY region, sale_id
LIMIT 40;
 region | sale_id | amount  | rank_within_region | diff_from_prev 
--------+---------+---------+--------------------+----------------
 east   |       2 |   31.50 |                125 |               
 east   |       6 |   94.50 |                124 |          63.00
 east   |      10 |  157.50 |                123 |          63.00
 east   |      14 |  220.50 |                122 |          63.00
 east   |      18 |  283.50 |                121 |          63.00
 east   |      22 |  346.50 |                120 |          63.00
 east   |      26 |  409.50 |                119 |          63.00
 east   |      30 |  472.50 |                118 |          63.00
 east   |      34 |  535.50 |                117 |          63.00
 east   |      38 |  598.50 |                116 |          63.00
 east   |      42 |  661.50 |                115 |          63.00
 east   |      46 |  724.50 |                114 |          63.00
 east   |      50 |  787.50 |                113 |          63.00
 east   |      54 |  850.50 |                112 |          63.00
 east   |      58 |  913.50 |                111 |          63.00
 east   |      62 |  976.50 |                110 |          63.00
 east   |      66 | 1039.50 |                109 |          63.00
 east   |      70 | 1102.50 |                108 |          63.00
 east   |      74 | 1165.50 |                107 |          63.00
 east   |      78 | 1228.50 |                106 |          63.00
 east   |      82 | 1291.50 |                105 |          63.00
 east   |      86 | 1354.50 |                104 |          63.00
 east   |      90 | 1417.50 |                103 |          63.00
 east   |      94 | 1480.50 |                102 |          63.00
 east   |      98 | 1543.50 |                101 |          63.00
 east   |     102 | 1606.50 |                100 |          63.00
 east   |     106 | 1669.50 |                 99 |          63.00
 east   |     110 | 1732.50 |                 98 |          63.00
 east   |     114 | 1795.50 |                 97 |          63.00
 east   |     118 | 1858.50 |                 96 |          63.00
 east   |     122 | 1921.50 |                 95 |          63.00
 east   |     126 | 1984.50 |                 94 |          63.00
 east   |     130 | 2047.50 |                 93 |          63.00
 east   |     134 | 2110.50 |                 92 |          63.00
 east   |     138 | 2173.50 |                 91 |          63.00
 east   |     142 | 2236.50 |                 90 |          63.00
 east   |     146 | 2299.50 |                 89 |          63.00
 east   |     150 | 2362.50 |                 88 |          63.00
 east   |     154 | 2425.50 |                 87 |          63.00
 east   |     158 | 2488.50 |                 86 |          63.00
(40 rows)

-- Wait for stats
SELECT pg_sleep(0.2);
 pg_sleep 
----------
 
(1 row)

-- Verify window function queries are tracked
SELECT 
  COUNT(*) FILTER (WHERE query LIKE '%OVER%' OR query LIKE '%window%') AS window_queries,
  COUNT(*) FILTER (WHERE query LIKE '%ROW_NUMBER%' OR query LIKE '%RANK%' OR query LIKE '%LAG%' OR query LIKE '%LEAD%') AS window_functions,
  COUNT(*) FILTER (WHERE query LIKE '%PARTITION BY%') AS partition_queries
FROM pg_stat_insights
WHERE query LIKE '%sales_data%' OR query LIKE '%employees%';
ERROR:  relation "pg_stat_insights" does not exist
LINE 5: FROM pg_stat_insights
             ^
-- Verify window function metrics
SELECT 
  calls >= 1 AS has_executions,
  rows > 0 AS returned_rows,
  total_exec_time > 0 AS has_execution_time
FROM pg_stat_insights
WHERE query LIKE '%OVER%' OR query LIKE '%window%'
LIMIT 1;
ERROR:  relation "pg_stat_insights" does not exist
LINE 5: FROM pg_stat_insights
             ^
