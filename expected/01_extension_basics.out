-- ============================================================================
-- Test 1: Extension Basics
-- Tests extension creation, versioning, and basic metadata
-- ============================================================================
-- Create the extension
CREATE EXTENSION pg_stat_insights;
-- Verify extension is installed
SELECT extname, extversion FROM pg_extension WHERE extname = 'pg_stat_insights';
     extname      | extversion 
------------------+------------
 pg_stat_insights | 3.0
(1 row)

-- Check that all main objects exist
SELECT proname FROM pg_proc WHERE proname LIKE 'pg_stat_insights%' ORDER BY proname;
                proname                 
----------------------------------------
 pg_stat_insights
 pg_stat_insights_index_lock_contention
 pg_stat_insights_index_size_snapshot
 pg_stat_insights_index_size_trends
 pg_stat_insights_replication_stats
 pg_stat_insights_reset
 pg_stat_insights_reset
(7 rows)

-- Check that all views exist
SELECT viewname FROM pg_views WHERE viewname LIKE 'pg_stat_insights%' ORDER BY viewname;
                 viewname                 
------------------------------------------
 pg_stat_insights
 pg_stat_insights_by_bucket
 pg_stat_insights_errors
 pg_stat_insights_histogram_summary
 pg_stat_insights_index_alerts
 pg_stat_insights_index_bloat
 pg_stat_insights_index_dashboard
 pg_stat_insights_index_efficiency
 pg_stat_insights_index_lock_contention
 pg_stat_insights_index_maintenance
 pg_stat_insights_index_size_trends
 pg_stat_insights_index_summary
 pg_stat_insights_index_usage
 pg_stat_insights_indexes
 pg_stat_insights_logical_replication
 pg_stat_insights_missing_indexes
 pg_stat_insights_physical_replication
 pg_stat_insights_plan_errors
 pg_stat_insights_publications
 pg_stat_insights_replication
 pg_stat_insights_replication_alerts
 pg_stat_insights_replication_bottlenecks
 pg_stat_insights_replication_conflicts
 pg_stat_insights_replication_dashboard
 pg_stat_insights_replication_health
 pg_stat_insights_replication_origins
 pg_stat_insights_replication_performance
 pg_stat_insights_replication_slots
 pg_stat_insights_replication_summary
 pg_stat_insights_replication_timeline
 pg_stat_insights_replication_wal
 pg_stat_insights_slow_queries
 pg_stat_insights_subscription_stats
 pg_stat_insights_subscriptions
 pg_stat_insights_top_by_calls
 pg_stat_insights_top_by_io
 pg_stat_insights_top_by_time
 pg_stat_insights_top_cache_misses
(38 rows)

-- Verify function signatures
\df pg_stat_insights_reset
                                        List of functions
 Schema |          Name          | Result data type |         Argument data types          | Type 
--------+------------------------+------------------+--------------------------------------+------
 public | pg_stat_insights_reset | void             |                                      | func
 public | pg_stat_insights_reset | void             | userid oid, dbid oid, queryid bigint | func
(2 rows)

-- Test basic function calls (should not error)
SELECT pg_stat_insights_reset();
 pg_stat_insights_reset 
------------------------
 
(1 row)

-- Verify main view is accessible
SELECT COUNT(*) >= 0 AS view_accessible FROM pg_stat_insights;
 view_accessible 
-----------------
 t
(1 row)

