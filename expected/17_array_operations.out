-- ============================================================================
-- Test 17: Array Operations
-- Tests tracking of array queries and operations
-- ============================================================================
-- Reset statistics
SELECT pg_stat_insights_reset();
ERROR:  function pg_stat_insights_reset() does not exist
LINE 1: SELECT pg_stat_insights_reset();
               ^
HINT:  No function matches the given name and argument types. You might need to add explicit type casts.
-- Create test table with array columns
SELECT setseed(0.5);
 setseed 
---------
 
(1 row)

CREATE TEMP TABLE array_test (
  id serial PRIMARY KEY,
  int_array int[],
  text_array text[],
  numeric_array numeric[],
  jsonb_array jsonb[],
  multi_dim_array int[][],
  created_at timestamp DEFAULT '2025-10-31 12:00:00'::timestamp
);
-- Insert deterministic array data
INSERT INTO array_test (int_array, text_array, numeric_array, jsonb_array, multi_dim_array)
SELECT 
  ARRAY[1 + i, 2 + i, 3 + i, 4 + i, 5 + i],
  ARRAY['item_' || i, 'value_' || i, 'tag_' || (i % 10)],
  ARRAY[(i * 1.1)::numeric, (i * 2.2)::numeric, (i * 3.3)::numeric],
  ARRAY[
    jsonb_build_object('id', i, 'val', i * 2),
    jsonb_build_object('id', i + 1, 'val', (i + 1) * 2)
  ],
  ARRAY[[i, i+1], [i+2, i+3]]
FROM generate_series(1, 300) i;
-- Create GIN indexes for arrays
CREATE INDEX idx_array_int ON array_test USING GIN (int_array);
CREATE INDEX idx_array_text ON array_test USING GIN (text_array);
-- Test array element access
SELECT id, int_array[1] AS first_element, int_array[array_length(int_array, 1)] AS last_element
FROM array_test
WHERE int_array[1] > 50
ORDER BY id
LIMIT 20;
 id | first_element | last_element 
----+---------------+--------------
 50 |            51 |           55
 51 |            52 |           56
 52 |            53 |           57
 53 |            54 |           58
 54 |            55 |           59
 55 |            56 |           60
 56 |            57 |           61
 57 |            58 |           62
 58 |            59 |           63
 59 |            60 |           64
 60 |            61 |           65
 61 |            62 |           66
 62 |            63 |           67
 63 |            64 |           68
 64 |            65 |           69
 65 |            66 |           70
 66 |            67 |           71
 67 |            68 |           72
 68 |            69 |           73
 69 |            70 |           74
(20 rows)

-- Test array contains (@>)
SELECT id, int_array
FROM array_test
WHERE int_array @> ARRAY[10, 11]
ORDER BY id
LIMIT 15;
 id |    int_array     
----+------------------
  6 | {7,8,9,10,11}
  7 | {8,9,10,11,12}
  8 | {9,10,11,12,13}
  9 | {10,11,12,13,14}
(4 rows)

-- Test array overlap (&&)
SELECT id, int_array
FROM array_test
WHERE int_array && ARRAY[5, 10, 15, 20]
ORDER BY id
LIMIT 25;
 id |    int_array     
----+------------------
  1 | {2,3,4,5,6}
  2 | {3,4,5,6,7}
  3 | {4,5,6,7,8}
  4 | {5,6,7,8,9}
  5 | {6,7,8,9,10}
  6 | {7,8,9,10,11}
  7 | {8,9,10,11,12}
  8 | {9,10,11,12,13}
  9 | {10,11,12,13,14}
 10 | {11,12,13,14,15}
 11 | {12,13,14,15,16}
 12 | {13,14,15,16,17}
 13 | {14,15,16,17,18}
 14 | {15,16,17,18,19}
 15 | {16,17,18,19,20}
 16 | {17,18,19,20,21}
 17 | {18,19,20,21,22}
 18 | {19,20,21,22,23}
 19 | {20,21,22,23,24}
(19 rows)

-- Test array length
SELECT id, array_length(int_array, 1) AS arr_length
FROM array_test
WHERE array_length(int_array, 1) > 4
ORDER BY id
LIMIT 30;
 id | arr_length 
----+------------
  1 |          5
  2 |          5
  3 |          5
  4 |          5
  5 |          5
  6 |          5
  7 |          5
  8 |          5
  9 |          5
 10 |          5
 11 |          5
 12 |          5
 13 |          5
 14 |          5
 15 |          5
 16 |          5
 17 |          5
 18 |          5
 19 |          5
 20 |          5
 21 |          5
 22 |          5
 23 |          5
 24 |          5
 25 |          5
 26 |          5
 27 |          5
 28 |          5
 29 |          5
 30 |          5
(30 rows)

-- Test array append (||)
SELECT id, int_array || 999 AS appended_array
FROM array_test
WHERE id <= 10
ORDER BY id;
 id |    appended_array    
----+----------------------
  1 | {2,3,4,5,6,999}
  2 | {3,4,5,6,7,999}
  3 | {4,5,6,7,8,999}
  4 | {5,6,7,8,9,999}
  5 | {6,7,8,9,10,999}
  6 | {7,8,9,10,11,999}
  7 | {8,9,10,11,12,999}
  8 | {9,10,11,12,13,999}
  9 | {10,11,12,13,14,999}
 10 | {11,12,13,14,15,999}
(10 rows)

-- Test array concatenation
SELECT id, int_array || ARRAY[100, 200, 300] AS concatenated
FROM array_test
WHERE id <= 15
ORDER BY id;
 id |         concatenated         
----+------------------------------
  1 | {2,3,4,5,6,100,200,300}
  2 | {3,4,5,6,7,100,200,300}
  3 | {4,5,6,7,8,100,200,300}
  4 | {5,6,7,8,9,100,200,300}
  5 | {6,7,8,9,10,100,200,300}
  6 | {7,8,9,10,11,100,200,300}
  7 | {8,9,10,11,12,100,200,300}
  8 | {9,10,11,12,13,100,200,300}
  9 | {10,11,12,13,14,100,200,300}
 10 | {11,12,13,14,15,100,200,300}
 11 | {12,13,14,15,16,100,200,300}
 12 | {13,14,15,16,17,100,200,300}
 13 | {14,15,16,17,18,100,200,300}
 14 | {15,16,17,18,19,100,200,300}
 15 | {16,17,18,19,20,100,200,300}
(15 rows)

-- Test unnest arrays
SELECT id, unnest(int_array) AS array_value
FROM array_test
WHERE id <= 5
ORDER BY id, array_value;
 id | array_value 
----+-------------
  1 |           2
  1 |           3
  1 |           4
  1 |           5
  1 |           6
  2 |           3
  2 |           4
  2 |           5
  2 |           6
  2 |           7
  3 |           4
  3 |           5
  3 |           6
  3 |           7
  3 |           8
  4 |           5
  4 |           6
  4 |           7
  4 |           8
  4 |           9
  5 |           6
  5 |           7
  5 |           8
  5 |           9
  5 |          10
(25 rows)

-- Test array_agg aggregation
SELECT 
  id % 10 AS group_id,
  array_agg(int_array[1] ORDER BY int_array[1]) AS aggregated_values
FROM array_test
GROUP BY id % 10
ORDER BY group_id;
 group_id |                                                aggregated_values                                                 
----------+------------------------------------------------------------------------------------------------------------------
        0 | {11,21,31,41,51,61,71,81,91,101,111,121,131,141,151,161,171,181,191,201,211,221,231,241,251,261,271,281,291,301}
        1 | {2,12,22,32,42,52,62,72,82,92,102,112,122,132,142,152,162,172,182,192,202,212,222,232,242,252,262,272,282,292}
        2 | {3,13,23,33,43,53,63,73,83,93,103,113,123,133,143,153,163,173,183,193,203,213,223,233,243,253,263,273,283,293}
        3 | {4,14,24,34,44,54,64,74,84,94,104,114,124,134,144,154,164,174,184,194,204,214,224,234,244,254,264,274,284,294}
        4 | {5,15,25,35,45,55,65,75,85,95,105,115,125,135,145,155,165,175,185,195,205,215,225,235,245,255,265,275,285,295}
        5 | {6,16,26,36,46,56,66,76,86,96,106,116,126,136,146,156,166,176,186,196,206,216,226,236,246,256,266,276,286,296}
        6 | {7,17,27,37,47,57,67,77,87,97,107,117,127,137,147,157,167,177,187,197,207,217,227,237,247,257,267,277,287,297}
        7 | {8,18,28,38,48,58,68,78,88,98,108,118,128,138,148,158,168,178,188,198,208,218,228,238,248,258,268,278,288,298}
        8 | {9,19,29,39,49,59,69,79,89,99,109,119,129,139,149,159,169,179,189,199,209,219,229,239,249,259,269,279,289,299}
        9 | {10,20,30,40,50,60,70,80,90,100,110,120,130,140,150,160,170,180,190,200,210,220,230,240,250,260,270,280,290,300}
(10 rows)

-- Test array functions
SELECT 
  id,
  array_dims(int_array) AS dimensions,
  array_lower(int_array, 1) AS lower_bound,
  array_upper(int_array, 1) AS upper_bound
FROM array_test
WHERE id <= 10
ORDER BY id;
 id | dimensions | lower_bound | upper_bound 
----+------------+-------------+-------------
  1 | [1:5]      |           1 |           5
  2 | [1:5]      |           1 |           5
  3 | [1:5]      |           1 |           5
  4 | [1:5]      |           1 |           5
  5 | [1:5]      |           1 |           5
  6 | [1:5]      |           1 |           5
  7 | [1:5]      |           1 |           5
  8 | [1:5]      |           1 |           5
  9 | [1:5]      |           1 |           5
 10 | [1:5]      |           1 |           5
(10 rows)

-- Test array_remove
SELECT id, array_remove(int_array, 5) AS removed_array
FROM array_test
WHERE 5 = ANY(int_array)
ORDER BY id
LIMIT 20;
 id | removed_array 
----+---------------
  1 | {2,3,4,6}
  2 | {3,4,6,7}
  3 | {4,6,7,8}
  4 | {6,7,8,9}
(4 rows)

-- Test array_replace
SELECT id, array_replace(int_array, 10, 999) AS replaced_array
FROM array_test
WHERE 10 = ANY(int_array)
ORDER BY id
LIMIT 15;
 id |  replaced_array   
----+-------------------
  5 | {6,7,8,9,999}
  6 | {7,8,9,999,11}
  7 | {8,9,999,11,12}
  8 | {9,999,11,12,13}
  9 | {999,11,12,13,14}
(5 rows)

-- Test array_position
SELECT id, array_position(int_array, 50) AS position_of_50
FROM array_test
WHERE 50 = ANY(int_array)
ORDER BY id
LIMIT 10;
 id | position_of_50 
----+----------------
 45 |              5
 46 |              4
 47 |              3
 48 |              2
 49 |              1
(5 rows)

-- Test array_positions
SELECT id, array_positions(int_array, 25) AS positions_of_25
FROM array_test
WHERE 25 = ANY(int_array)
ORDER BY id
LIMIT 10;
 id | positions_of_25 
----+-----------------
 20 | {5}
 21 | {4}
 22 | {3}
 23 | {2}
 24 | {1}
(5 rows)

-- Test ANY and ALL operators
SELECT id, int_array
FROM array_test
WHERE 100 = ANY(int_array)
ORDER BY id
LIMIT 20;
 id |       int_array       
----+-----------------------
 95 | {96,97,98,99,100}
 96 | {97,98,99,100,101}
 97 | {98,99,100,101,102}
 98 | {99,100,101,102,103}
 99 | {100,101,102,103,104}
(5 rows)

SELECT id, int_array
FROM array_test
WHERE 1000 = ALL(int_array)
ORDER BY id
LIMIT 5;
 id | int_array 
----+-----------
(0 rows)

-- Test text array operations
SELECT id, text_array
FROM array_test
WHERE text_array @> ARRAY['item_50', 'value_50']
ORDER BY id
LIMIT 10;
 id |        text_array        
----+--------------------------
 50 | {item_50,value_50,tag_0}
(1 row)

-- Test numeric array operations
SELECT 
  id,
  numeric_array[1] + numeric_array[2] AS sum_first_two
FROM array_test
WHERE array_length(numeric_array, 1) >= 2
ORDER BY id
LIMIT 25;
 id | sum_first_two 
----+---------------
  1 |           3.3
  2 |           6.6
  3 |           9.9
  4 |          13.2
  5 |          16.5
  6 |          19.8
  7 |          23.1
  8 |          26.4
  9 |          29.7
 10 |          33.0
 11 |          36.3
 12 |          39.6
 13 |          42.9
 14 |          46.2
 15 |          49.5
 16 |          52.8
 17 |          56.1
 18 |          59.4
 19 |          62.7
 20 |          66.0
 21 |          69.3
 22 |          72.6
 23 |          75.9
 24 |          79.2
 25 |          82.5
(25 rows)

-- Test jsonb array operations
SELECT 
  id,
  jsonb_array[1]->>'id' AS first_jsonb_id
FROM array_test
WHERE array_length(jsonb_array, 1) > 0
ORDER BY id
LIMIT 20;
 id | first_jsonb_id 
----+----------------
  1 | 1
  2 | 2
  3 | 3
  4 | 4
  5 | 5
  6 | 6
  7 | 7
  8 | 8
  9 | 9
 10 | 10
 11 | 11
 12 | 12
 13 | 13
 14 | 14
 15 | 15
 16 | 16
 17 | 17
 18 | 18
 19 | 19
 20 | 20
(20 rows)

-- Test multidimensional arrays
SELECT 
  id,
  multi_dim_array[1][1] AS first_dim_first,
  multi_dim_array[1][2] AS first_dim_second,
  array_dims(multi_dim_array) AS dims
FROM array_test
WHERE id <= 10
ORDER BY id;
 id | first_dim_first | first_dim_second |    dims    
----+-----------------+------------------+------------
  1 |               1 |                2 | [1:2][1:2]
  2 |               2 |                3 | [1:2][1:2]
  3 |               3 |                4 | [1:2][1:2]
  4 |               4 |                5 | [1:2][1:2]
  5 |               5 |                6 | [1:2][1:2]
  6 |               6 |                7 | [1:2][1:2]
  7 |               7 |                8 | [1:2][1:2]
  8 |               8 |                9 | [1:2][1:2]
  9 |               9 |               10 | [1:2][1:2]
 10 |              10 |               11 | [1:2][1:2]
(10 rows)

-- Test array slicing
SELECT 
  id,
  int_array[1:3] AS first_three,
  int_array[2:4] AS middle_slice
FROM array_test
WHERE array_length(int_array, 1) >= 4
ORDER BY id
LIMIT 15;
 id | first_three | middle_slice 
----+-------------+--------------
  1 | {2,3,4}     | {3,4,5}
  2 | {3,4,5}     | {4,5,6}
  3 | {4,5,6}     | {5,6,7}
  4 | {5,6,7}     | {6,7,8}
  5 | {6,7,8}     | {7,8,9}
  6 | {7,8,9}     | {8,9,10}
  7 | {8,9,10}    | {9,10,11}
  8 | {9,10,11}   | {10,11,12}
  9 | {10,11,12}  | {11,12,13}
 10 | {11,12,13}  | {12,13,14}
 11 | {12,13,14}  | {13,14,15}
 12 | {13,14,15}  | {14,15,16}
 13 | {14,15,16}  | {15,16,17}
 14 | {15,16,17}  | {16,17,18}
 15 | {16,17,18}  | {17,18,19}
(15 rows)

-- Test array_to_string
SELECT 
  id,
  array_to_string(text_array, ' | ') AS joined_text
FROM array_test
WHERE id <= 10
ORDER BY id;
 id |        joined_text         
----+----------------------------
  1 | item_1 | value_1 | tag_1
  2 | item_2 | value_2 | tag_2
  3 | item_3 | value_3 | tag_3
  4 | item_4 | value_4 | tag_4
  5 | item_5 | value_5 | tag_5
  6 | item_6 | value_6 | tag_6
  7 | item_7 | value_7 | tag_7
  8 | item_8 | value_8 | tag_8
  9 | item_9 | value_9 | tag_9
 10 | item_10 | value_10 | tag_0
(10 rows)

-- Test string_to_array
SELECT 
  id,
  string_to_array(array_to_string(text_array, ','), ',') AS split_text
FROM array_test
WHERE id <= 5
ORDER BY id;
 id |       split_text       
----+------------------------
  1 | {item_1,value_1,tag_1}
  2 | {item_2,value_2,tag_2}
  3 | {item_3,value_3,tag_3}
  4 | {item_4,value_4,tag_4}
  5 | {item_5,value_5,tag_5}
(5 rows)

-- Test array comparison operators
SELECT id, int_array
FROM array_test
WHERE int_array < ARRAY[100, 101, 102, 103, 104]
ORDER BY id
LIMIT 20;
 id |    int_array     
----+------------------
  1 | {2,3,4,5,6}
  2 | {3,4,5,6,7}
  3 | {4,5,6,7,8}
  4 | {5,6,7,8,9}
  5 | {6,7,8,9,10}
  6 | {7,8,9,10,11}
  7 | {8,9,10,11,12}
  8 | {9,10,11,12,13}
  9 | {10,11,12,13,14}
 10 | {11,12,13,14,15}
 11 | {12,13,14,15,16}
 12 | {13,14,15,16,17}
 13 | {14,15,16,17,18}
 14 | {15,16,17,18,19}
 15 | {16,17,18,19,20}
 16 | {17,18,19,20,21}
 17 | {18,19,20,21,22}
 18 | {19,20,21,22,23}
 19 | {20,21,22,23,24}
 20 | {21,22,23,24,25}
(20 rows)

SELECT id, int_array
FROM array_test
WHERE int_array > ARRAY[1, 2, 3, 4, 5]
ORDER BY id
LIMIT 15;
 id |    int_array     
----+------------------
  1 | {2,3,4,5,6}
  2 | {3,4,5,6,7}
  3 | {4,5,6,7,8}
  4 | {5,6,7,8,9}
  5 | {6,7,8,9,10}
  6 | {7,8,9,10,11}
  7 | {8,9,10,11,12}
  8 | {9,10,11,12,13}
  9 | {10,11,12,13,14}
 10 | {11,12,13,14,15}
 11 | {12,13,14,15,16}
 12 | {13,14,15,16,17}
 13 | {14,15,16,17,18}
 14 | {15,16,17,18,19}
 15 | {16,17,18,19,20}
(15 rows)

-- Wait for stats
SELECT pg_sleep(0.2);
 pg_sleep 
----------
 
(1 row)

-- Verify array operations are tracked
SELECT 
  COUNT(*) FILTER (WHERE query LIKE '%array%' OR query LIKE '%ARRAY%') AS array_queries,
  COUNT(*) FILTER (WHERE query LIKE '%@>%' OR query LIKE '%&&%' OR query LIKE '%ANY%') AS array_operators,
  COUNT(*) FILTER (WHERE query LIKE '%unnest%' OR query LIKE '%array_%') AS array_functions
FROM pg_stat_insights
WHERE query LIKE '%array_test%';
ERROR:  relation "pg_stat_insights" does not exist
LINE 5: FROM pg_stat_insights
             ^
-- Verify array query metrics
SELECT 
  calls >= 1 AS has_executions,
  rows > 0 AS returned_rows,
  total_exec_time > 0 AS has_execution_time
FROM pg_stat_insights
WHERE query LIKE '%array_test%' AND calls > 0
LIMIT 1;
ERROR:  relation "pg_stat_insights" does not exist
LINE 5: FROM pg_stat_insights
             ^
