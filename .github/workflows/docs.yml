name: Deploy Documentation to GitHub Pages

# Manual trigger only
on:
  workflow_dispatch:

# Sets permissions for GitHub Pages
permissions:
  contents: read
  pages: write
  id-token: write

# Allow only one concurrent deployment
concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install MkDocs and dependencies
        run: |
          pip install mkdocs mkdocs-material mkdocs-minify-plugin pymdown-extensions

      - name: Create MkDocs configuration
        run: |
          cat > mkdocs.yml << 'EOF'
          site_name: pg_stat_insights Documentation
          site_description: Advanced PostgreSQL Query Performance Monitoring
          site_author: pgElephant, Inc.
          repo_url: https://github.com/pgelephant/pg_stat_insights
          repo_name: pgelephant/pg_stat_insights
          
          theme:
            name: material
            palette:
              primary: indigo
              accent: blue
            features:
              - navigation.instant
              - navigation.tracking
              - navigation.tabs
              - navigation.sections
              - navigation.expand
              - navigation.top
              - search.suggest
              - search.highlight
              - content.code.copy
            icon:
              repo: fontawesome/brands/github
          
          markdown_extensions:
            - admonition
            - pymdownx.details
            - pymdownx.superfences
            - pymdownx.tabbed:
                alternate_style: true
            - pymdownx.highlight:
                anchor_linenums: true
            - pymdownx.inlinehilite
            - pymdownx.snippets
            - tables
            - toc:
                permalink: true
          
          nav:
            - Home: README.md
            - Installation: INSTALL.md
            - Configuration: configuration.md
            - Features: features.md
            - Contributing: CONTRIBUTING.md
          
          plugins:
            - search
            - minify:
                minify_html: true
          
          extra:
            social:
              - icon: fontawesome/brands/github
                link: https://github.com/pgelephant/pg_stat_insights
              - icon: fontawesome/brands/twitter
                link: https://twitter.com/pgelephant
          EOF

      - name: Create documentation pages
        run: |
          mkdir -p docs
          
          # Copy main docs
          cp README.md docs/
          cp INSTALL.md docs/
          cp CONTRIBUTING.md docs/
          
          # Create configuration page
          cat > docs/configuration.md << 'EOFCONF'
          # Configuration Guide
          
          ## Quick Start
          
          ```sql
          ALTER SYSTEM SET shared_preload_libraries = 'pg_stat_insights';
          -- Restart PostgreSQL
          CREATE EXTENSION pg_stat_insights;
          ```
          
          ## Core Parameters
          
          ### pg_stat_insights.max
          - **Default**: 5000
          - **Range**: 100 to INT_MAX/2
          - **Context**: POSTMASTER (requires restart)
          
          Maximum number of distinct queries to track.
          
          ### pg_stat_insights.track
          - **Default**: 'top'
          - **Values**: 'none', 'top', 'all'
          - **Context**: SUSET
          
          Which statements to track.
          
          ### pg_stat_insights.track_planning
          - **Default**: off
          - **Context**: SUSET
          
          Track planning duration separately from execution.
          
          ## Advanced Features
          
          ### Histogram Tracking
          
          ```sql
          ALTER SYSTEM SET pg_stat_insights.track_histograms = on;
          ```
          
          Enables response time, I/O, and row count histograms.
          
          ### Time-Series Buckets
          
          ```sql
          ALTER SYSTEM SET pg_stat_insights.bucket_time = 300;  -- 5 minutes
          ALTER SYSTEM SET pg_stat_insights.max_buckets = 12;   -- 1 hour history
          ```
          
          ### Parameter Capture (Use with Caution)
          
          ```sql
          -- ⚠️ May expose sensitive data
          ALTER SYSTEM SET pg_stat_insights.capture_parameters = off;  -- Keep OFF in production
          ```
          
          ### Plan Text Capture
          
          ```sql
          -- ⚠️ High storage cost
          ALTER SYSTEM SET pg_stat_insights.capture_plan_text = off;  -- Keep OFF in production
          ```
          
          ## Production Recommendations
          
          ```sql
          -- Balanced production setup
          ALTER SYSTEM SET pg_stat_insights.max = 10000;
          ALTER SYSTEM SET pg_stat_insights.track = 'top';
          ALTER SYSTEM SET pg_stat_insights.track_planning = on;
          ALTER SYSTEM SET pg_stat_insights.track_histograms = on;
          ALTER SYSTEM SET pg_stat_insights.bucket_time = 300;
          ALTER SYSTEM SET pg_stat_insights.max_buckets = 12;
          ALTER SYSTEM SET pg_stat_insights.capture_parameters = off;
          ALTER SYSTEM SET pg_stat_insights.capture_plan_text = off;
          
          SELECT pg_reload_conf();
          ```
          
          ## See Also
          
          - [Installation Guide](INSTALL.md)
          - [Complete README](README.md)
          EOFCONF
          
          # Create features page
          cat > docs/features.md << 'EOFFEAT'
          # Features Overview
          
          ## 🎯 Key Capabilities
          
          ### Comprehensive Metrics
          - **145 total metrics** - More than pg_stat_statements + pg_stat_monitor combined
          - Response time distribution histograms
          - I/O intensity tracking
          - Memory usage breakdown
          - Network performance metrics
          
          ### Performance Analysis
          - Percentile statistics (p50, p95, p99)
          - Plan accuracy tracking
          - Cache efficiency analysis
          - Wait event monitoring
          
          ### Time-Series Support
          - Configurable time buckets
          - Historical trending
          - Aggregate views by time period
          
          ### Error Monitoring
          - Per-query error counts
          - Last error messages
          - Retry tracking
          - State change monitoring
          
          ### Security & Privacy
          - Optional parameter capture (OFF by default)
          - Role-based access control
          - Sensitive data protection
          - Configurable detail levels
          
          ## 📊 Pre-built Views
          
          | View | Purpose |
          |------|---------|
          | `pg_stat_insights_top_by_time` | Slowest queries by total time |
          | `pg_stat_insights_top_by_calls` | Most frequently called queries |
          | `pg_stat_insights_top_by_io` | Highest I/O consumers |
          | `pg_stat_insights_top_cache_misses` | Poor cache performers |
          | `pg_stat_insights_plan_errors` | Plan estimation issues |
          | `pg_stat_insights_slow_queries` | High-latency queries |
          | `pg_stat_insights_errors` | Queries with errors |
          | `pg_stat_insights_histogram_summary` | Response time distribution |
          | `pg_stat_insights_by_bucket` | Time-series aggregation |
          
          ## 🚀 Performance Impact
          
          | Configuration | Overhead | Use Case |
          |---------------|----------|----------|
          | Minimal | <0.5% | High-performance prod |
          | Standard | ~1% | Typical production |
          | Full features | ~2% | Development/debugging |
          | + Parameters | +1-2% | Investigation only |
          | + Plan text | +2-5% | Deep debugging only |
          
          ## 📈 Histograms
          
          ### Response Time (10 buckets)
          - <1ms, 1-10ms, 10-100ms, 100ms-1s
          - 1-10s, 10-60s, 1-5min, 5-10min
          - 10-30min, >30min
          
          ### I/O Intensity (5 buckets)
          - 0 blocks, 1-10, 11-100, 101-1000, >1000
          
          ### Row Count (5 buckets)
          - 0 rows, 1-10, 11-100, 101-1000, >1000
          EOFFEAT

      - name: Build documentation
        run: mkdocs build --strict

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v4
        with:
          path: ./site

  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
